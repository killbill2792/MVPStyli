import React, { createContext, useContext, useMemo, useEffect, useState } from 'react';
import { SafeAreaView, View, Text, Pressable, Image, FlatList, StyleSheet, Alert, StatusBar, TextInput, ScrollView, TouchableWithoutFeedback } from 'react-native';
import * as ImagePicker from 'expo-image-picker';
import { customAlphabet } from 'nanoid/non-secure';
import { supabase, isDemo } from './lib/supabase';
import { uploadImageAsync } from './lib/upload';
import { getCleanGarmentUrl } from './lib/cleaner';
import { startTryOn, pollTryOn } from './lib/tryon';
import { UserProvider, useUser } from './lib/UserContext';
import SignInScreen from './screens/SignIn';
import AccountScreen from './screens/Account';

/** MVPStyli ‚Äî Production build with Supabase + Vercel */

const nano = customAlphabet('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', 8);
const Ctx = createContext(null);
function rid() { return nano(); }

// Console tracking
function track(event: string, data: any = {}) {
  console.log(`[TRACK] ${event}:`, data);
}

const initial = {
  route: 'signin',
  params: {},
  twinUri: null,
  products: [
    { id: 'denim-jacket', title: 'ASOS Denim Jacket', price: 69, rating: 4.6, image: 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?q=80&auto=format&fit=crop&w=1200', category: 'upper' },
    { id: 'black-blazer', title: 'Zara Black Blazer', price: 119, rating: 4.4, image: 'https://images.unsplash.com/photo-1503342217505-b0a15cf70489?q=80&auto=format&fit=crop&w=1200', category: 'upper' },
    { id: 'silk-dress', title: 'COS Silk Dress', price: 159, rating: 4.7, image: 'https://images.unsplash.com/photo-1544441893-675973e31985?q=80&auto=format&fit=crop&w=1200', category: 'dress' },
    { id: 'white-sneakers', title: 'Nike Air Force 1', price: 90, rating: 4.8, image: 'https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&auto=format&fit=crop&w=1200', category: 'lower' },
    { id: 'leather-bag', title: 'Coach Leather Tote', price: 295, rating: 4.5, image: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?q=80&auto=format&fit=crop&w=1200', category: 'upper' },
    { id: 'knit-sweater', title: 'Uniqlo Cashmere', price: 79, rating: 4.3, image: 'https://images.unsplash.com/photo-1434389677669-e08b4cac3105?q=80&auto=format&fit=crop&w=1200', category: 'upper' }
  ],
  currentProductId: 'denim-jacket',
  looks: [{ id: 'l1', uri: 'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&auto=format&fit=crop&w=1200' }],
  rooms: [],
  feedItems: [
    { id: 'f1', uri: 'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&auto=format&fit=crop&w=1200', handle: '@mina', sub: 'Party ‚Ä¢ Streetwear', yes: 82, maybe: 15, no: 9 },
    { id: 'f2', uri: 'https://images.unsplash.com/photo-1503342217505-b0a15cf70489?q=80&auto=format&fit=crop&w=1200', handle: '@sophia', sub: 'Office ‚Ä¢ Minimalist', yes: 67, maybe: 23, no: 12 },
    { id: 'f3', uri: 'https://images.unsplash.com/photo-1544441893-675973e31985?q=80&auto=format&fit=crop&w=1200', handle: '@zara', sub: 'Casual ‚Ä¢ Boho', yes: 91, maybe: 7, no: 4 },
    { id: 'f4', uri: 'https://images.unsplash.com/photo-1434389677669-e08b4cac3105?q=80&auto=format&fit=crop&w=1200', handle: '@emma', sub: 'Weekend ‚Ä¢ Cozy', yes: 74, maybe: 18, no: 8 }
  ],
  currentFeedIndex: 0
};

export function AppProvider({ children }) {
  const [state, setState] = useState(initial);
  
  const api = useMemo(() => ({
    state,
    setRoute: (route, params) => setState(s => ({ ...s, route, params: params || {} })),
    setTwinUri: (uri) => setState(s => ({ ...s, twinUri: uri })),
    setCurrentProduct: (id) => setState(s => ({ ...s, currentProductId: id })),
    nextFeedItem: () => setState(s => ({ ...s, currentFeedIndex: (s.currentFeedIndex + 1) % s.feedItems.length })),
    createRoom: ({ lookId, mode, durationMins = 60, title }) => {
      const room = {
        id: rid(),
        lookId,
        mode,
        title: title || mode,
        expiresAt: Date.now() + durationMins * 60 * 1000,
        status: 'active',
        votes: { yes: 0, maybe: 0, no: 0 }
      };
      setState(s => ({ ...s, rooms: [room, ...s.rooms] }));
      return room;
    },
    vote: (roomId, label) => setState(s => ({
      ...s,
      rooms: s.rooms.map(r => r.id === roomId ? { ...r, votes: { ...r.votes, [label]: r.votes[label] + 1 } } : r)
    })),
    tick: () => setState(s => ({
      ...s,
      rooms: s.rooms.map(r => (Date.now() > r.expiresAt && r.status === 'active') ? { ...r, status: 'expired' } : r)
    }))
  }), [state]);
  
  return <Ctx.Provider value={api}>{children}</Ctx.Provider>;
}

export const useApp = () => useContext(Ctx);

export default function App() {
  return (
    <UserProvider>
      <AppProvider>
        <Shell />
      </AppProvider>
    </UserProvider>
  );
}

function Shell() {
  const { state: { route }, setRoute } = useApp();
  const { user } = useUser();
  
  // If no user, always show sign in
  if (!user) {
    return <SignInScreen onDone={() => setRoute('onboarding')} />;
  }
  
  return (
    <SafeAreaView style={s.app}>
      <StatusBar barStyle="light-content" />
      <ScrollView style={s.container} showsVerticalScrollIndicator={false}>
        {route === 'onboarding' && <Onboarding />}
        {route === 'shop' && <Shop />}
        {route === 'product' && <Product />}
        {route === 'tryon' && <TryOn />}
        {route === 'askhelp' && <AskHelp />}
        {route === 'createpod' && <CreatePod />}
        {route === 'rooms' && <RoomsInbox />}
        {route === 'room_owner' && <RoomOwner />}
        {route === 'room_guest' && <RoomGuest />}
        {route === 'recap' && <Recap />}
        {route === 'feed' && <Feed />}
        {route === 'account' && <AccountScreen onBack={() => setRoute('shop')} />}
      </ScrollView>
      {/* Show navigation for all screens except signin */}
      {route !== 'signin' && <BottomBar route={route} go={setRoute} />}
    </SafeAreaView>
  );
}

/* BottomBar ‚Äî minimal */
function BottomBar({ route, go }) {
  const items = [
    ['shop', 'Shop'], ['feed', 'Feed'], ['tryon', 'Try-On'], ['rooms', 'Rooms']
  ];
  return (
    <View style={{
      position: 'absolute', left: 0, right: 0, bottom: 12,
      alignItems: 'center'
    }}>
      <View style={{
        flexDirection: 'row', gap: 10, backgroundColor: 'rgba(255,255,255,0.06)',
        borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, borderRadius: 9999,
        paddingHorizontal: 10, paddingVertical: 8
      }}>
        {items.map(([k, label]) => (
          <Pressable
            key={k}
            onPress={() => go(k)}
            style={{
              paddingHorizontal: 14, paddingVertical: 8, borderRadius: 9999,
              backgroundColor: route === k ? '#fff' : 'transparent'
            }}
          >
            <Text style={{
              color: route === k ? '#000' : '#d4d4d8',
              fontWeight: route === k ? '700' : '500'
            }}>{label}</Text>
          </Pressable>
        ))}
        <Pressable
          onPress={() => go('account')}
          style={{
            paddingHorizontal: 14, paddingVertical: 8, borderRadius: 9999,
            backgroundColor: route === 'account' ? '#fff' : 'transparent'
          }}
        >
          <Text style={{
            color: route === 'account' ? '#000' : '#d4d4d8',
            fontWeight: route === 'account' ? '700' : '500'
          }}>‚öôÔ∏è</Text>
        </Pressable>
      </View>
    </View>
  );
}

/* ---------------- Screens ---------------- */
function Onboarding() {
  const { setTwinUri, setRoute, state: { twinUri } } = useApp();
  
  const pick = async () => {
    try {
      const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permission required', 'Allow photo access.');
        return;
      }
      
      const res = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.9
      });
      
      if (!res.canceled) {
        track('upload_start');
        const publicUrl = await uploadImageAsync(res.assets[0].uri);
        setTwinUri(publicUrl);
        track('upload_success', { url: publicUrl });
        Alert.alert('Success', 'Photo uploaded successfully!');
      }
    } catch (error) {
      console.error('Upload error:', error);
      track('upload_error', { error: error.message });
      Alert.alert('Upload failed', 'Please try again.');
    }
  };
  
  const next = () => {
    if (twinUri) {
      setRoute('shop');
    } else {
      Alert.alert('Upload required', 'Please upload your photo.');
    }
  };
  
  return (
    <View style={s.grid2}>
      <Card>
        <Text style={s.h1}>Create Your Twin</Text>
        <Text style={s.muted}>Upload a clear photo. Everything else is optional.</Text>
        <View style={{ height: 12 }} />
        <Pressable style={s.inputBox} onPress={pick}>
          <Text style={s.label}>Upload Photo <Text style={{ color: '#f87171' }}>(required)</Text></Text>
          <Text style={s.inputHint}>Tap to choose from gallery</Text>
        </Pressable>
        <View style={{ height: 12 }} />
        <Pressable
          onPress={next}
          style={[s.btn, s.btnPrimary, !twinUri && { opacity: 0.5 }]}
          disabled={!twinUri}
        >
          <Text style={s.btnPrimaryText}>Continue ‚Üí</Text>
        </Pressable>
      </Card>
      <Card>
        <Text style={s.h1}>Preview</Text>
        <View style={s.full}>
          <Image
            source={{ uri: twinUri || 'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&auto=format&fit=crop&w=900' }}
            resizeMode="cover"
            style={StyleSheet.absoluteFillObject}
          />
        </View>
        <Text style={s.help}>Full-screen imagery for an AI-first feel.</Text>
      </Card>
    </View>
  );
}

function Shop() {
  const { state: { products }, setCurrentProduct, setRoute } = useApp();
  
  return (
    <View style={s.grid2}>
      <Card style={{ flex: 1 }}>
        <Text style={s.h1}>Curated for You</Text>
        <FlatList
          data={products}
          keyExtractor={(i) => i.id}
          numColumns={2}
          columnWrapperStyle={{ gap: 12 }}
          ItemSeparatorComponent={() => <View style={{ height: 12 }} />}
          scrollEnabled={false}
          renderItem={({ item }) => (
            <Pressable
              onPress={() => { setCurrentProduct(item.id); setRoute('product'); }}
              style={s.productCard}
              accessibilityLabel={`Open ${item.title}`}
            >
              <View style={s.fullSmall}>
                <Image source={{ uri: item.image }} resizeMode="cover" style={StyleSheet.absoluteFillObject} />
              </View>
              <View style={{ padding: 10 }}>
                <Text style={s.productTitle}>{item.title}</Text>
                <Text style={s.productMeta}>${item.price} ‚Ä¢ {item.rating}‚òÖ</Text>
              </View>
            </Pressable>
          )}
        />
      </Card>
      <Card style={{ width: '100%', maxWidth: 420 }}>
        <Text style={s.h2}>Trending Tags</Text>
        <View style={{ flexDirection: 'row', flexWrap: 'wrap', gap: 8, marginTop: 8 }}>
          {['#street', '#monochrome', '#y2k', '#partyfit', '#cozy'].map(t => <Tag key={t} text={t} />)}
        </View>
        <Text style={[s.h2, { marginTop: 16 }]}>Best Time to Post</Text>
        <Text style={s.muted}>Peers engage most 7‚Äì9pm. Get validation first ‚Üí then buy.</Text>
      </Card>
    </View>
  );
}

function Product() {
  const { state: { products, currentProductId }, setRoute } = useApp();
  const [cleanUrl, setCleanUrl] = useState(undefined);
  const [loading, setLoading] = useState(true);
  const p = products.find(x => x.id === currentProductId) || products[0];
  
  useEffect(() => {
    const cleanGarment = async () => {
      try {
        setLoading(true);
        const url = await getCleanGarmentUrl(p.id, p.image, p.category);
        setCleanUrl(url);
      } catch (error) {
        console.error('Garment cleaning failed:', error);
        setCleanUrl(p.image); // Fallback to original
      } finally {
        setLoading(false);
      }
    };
    
    cleanGarment();
  }, [p]);
  
  return (
    <View style={{ gap: 14 }}>
      <View style={s.full}>
        <Image source={{ uri: p.image }} resizeMode="cover" style={StyleSheet.absoluteFillObject} />
        <View style={s.topPill}><Text style={s.topPillText}>{p.title}</Text></View>
        <Pressable
          onPress={() => setRoute('tryon')}
          style={[s.btn, s.btnPrimary, s.btnFloating]}
          accessibilityLabel="Try this on"
        >
          <Text style={s.btnPrimaryText}>Try On</Text>
        </Pressable>
      </View>
      
      <View style={[s.card, { padding: 16, borderRadius: 24 }]}>
        <View style={s.rowBetween}>
          <Text style={{ color: '#e4e4e7', fontWeight: '700', fontSize: 16 }}>${p.price}</Text>
          <Text style={s.muted}>{p.rating}‚òÖ ¬∑ Free returns</Text>
        </View>
        <Text style={s.muted}>Fabric: Cotton blend ‚Ä¢ Care: Machine wash cold</Text>
        <Text style={s.muted}>Shipping: 2‚Äì4 days ‚Ä¢ Returns: 30 days</Text>
        
        <View style={s.row}>
          <Pressable
            disabled={loading || !cleanUrl}
            onPress={() => setRoute('tryon')}
            style={[s.btn, s.btnPrimary, { flex: 1 }, (loading || !cleanUrl) && { opacity: 0.5 }]}
          >
            <Text style={s.btnPrimaryText}>
              {loading ? 'Preparing‚Ä¶' : cleanUrl ? 'Try On' : 'Try another item'}
            </Text>
          </Pressable>
          <Pressable
            onPress={() => setRoute('askhelp')}
            style={[s.btn, s.btnGhost, { flex: 1 }]}
          >
            <Text>Ask for Help</Text>
          </Pressable>
        </View>
        <Pressable onPress={() => setRoute('shop')}><Text style={s.link}>Back to shop</Text></Pressable>
      </View>
    </View>
  );
}

function TryOn() {
  const { state: { twinUri, products, currentProductId }, setRoute, setTwinUri } = useApp();
  const [showAI, setShowAI] = useState(false);
  const [showSuggest, setShowSuggest] = useState(false);
  const [busy, setBusy] = useState(false);
  const [result, setResult] = useState(undefined);
  const [error, setError] = useState(null);
  
  const p = products.find(x => x.id === currentProductId) || products[0];
  
  // If no photo uploaded, show upload screen
  if (!twinUri) {
    return <TryOnUpload onUpload={setTwinUri} />;
  }
  
  const personUrl = twinUri;
  
  const startRealTryOn = async () => {
    try {
      setBusy(true);
      setError(null);
      
      track('tryon_start', { productId: currentProductId });
      const startTime = Date.now();
      
      // Get clean garment URL first
      const garmentCleanUrl = await getCleanGarmentUrl(p.id, p.image, p.category);
      
      // Start try-on job
      const { jobId } = await startTryOn(personUrl, garmentCleanUrl, p.category);
      
      // Poll for result
      let status;
      do {
        await new Promise(resolve => setTimeout(resolve, 2000)); // Poll every 2 seconds
        status = await pollTryOn(jobId);
        
        if (status.status === 'succeeded' && status.resultUrl) {
          setResult(status.resultUrl);
          const latency = Date.now() - startTime;
          track('tryon_success', { latencyMs: latency, productId: currentProductId });
          break;
        }
        
        if (status.status === 'failed') {
          throw new Error(status.error || 'Try-on failed');
        }
      } while (status.status === 'queued' || status.status === 'running');
      
    } catch (e) {
      console.error('Try-on failed:', e);
      track('tryon_fail', { error: e.message, productId: currentProductId });
      setError(e.message);
      setResult(personUrl); // Fallback to original
    } finally {
      setBusy(false);
    }
  };
  
  // Auto-start try-on when component mounts
  useEffect(() => {
    if (twinUri && !result && !busy) {
      startRealTryOn();
    }
  }, [twinUri, result, busy]);
  
  const pick = async () => {
    try {
      const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permission required', 'Allow photo access.');
        return;
      }
      
      const res = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.9
      });
      
      if (!res.canceled) {
        track('upload_start');
        const publicUrl = await uploadImageAsync(res.assets[0].uri);
        setTwinUri(publicUrl);
        setResult(undefined); // Reset result when photo changes
        track('upload_success', { url: publicUrl });
        Alert.alert('Success', 'Photo updated successfully!');
      }
    } catch (error) {
      console.error('Upload error:', error);
      track('upload_error', { error: error.message });
      Alert.alert('Upload failed', 'Please try again.');
    }
  };
  
  return (
    <TouchableWithoutFeedback onPress={() => { setShowAI(false); setShowSuggest(false); }}>
      <View style={{ alignItems: 'center' }}>
        <View style={s.full}>
          <Image
            source={{ uri: result || personUrl }}
            resizeMode="cover"
            style={StyleSheet.absoluteFillObject}
          />
          <View style={s.gradDown} />
          
          {/* Loading overlay */}
          {busy && (
            <View style={[StyleSheet.absoluteFillObject, { backgroundColor: 'rgba(0,0,0,0.7)', justifyContent: 'center', alignItems: 'center' }]}>
              <Text style={{ color: '#fff', fontSize: 18, fontWeight: '700', marginBottom: 8 }}>Generating Try-On...</Text>
              <Text style={{ color: '#d4d4d8', fontSize: 14 }}>AI is applying the outfit to your photo</Text>
            </View>
          )}
          
          {/* Error overlay */}
          {error && (
            <View style={[StyleSheet.absoluteFillObject, { backgroundColor: 'rgba(0,0,0,0.7)', justifyContent: 'center', alignItems: 'center' }]}>
              <Text style={{ color: '#f87171', fontSize: 16, fontWeight: '700', marginBottom: 8 }}>Try-on Failed</Text>
              <Text style={{ color: '#d4d4d8', fontSize: 14, textAlign: 'center' }}>{error}</Text>
            </View>
          )}
          
          <View style={s.rail}>
            <RailIcon icon="üìà" onPress={() => { setShowAI(v => !v); setShowSuggest(false); }} />
            <RailIcon icon="üí¨" onPress={() => setRoute('askhelp')} />
            <RailIcon icon="üß©" onPress={() => { setShowSuggest(v => !v); setShowAI(false); }} />
          </View>
          
          {showAI && (
            <Glass style={{ position: 'absolute', right: 12, top: 12, width: 330, padding: 18 }}>
              <Text style={{ color: '#e4e4e7', fontWeight: '700', marginBottom: 8, fontSize: 16 }}>AI Analytics</Text>
              <StatBar label="Confidence" value={82} />
              <Text style={{ color: '#a1a1aa', fontSize: 14, marginTop: 8 }}>Fit tips:</Text>
              <Text style={{ color: '#e4e4e7', fontSize: 14 }}>‚Ä¢ Shorten hem 2cm{'\n'}‚Ä¢ Add belt to define waist{'\n'}‚Ä¢ Perfect for your body type</Text>
              <View style={{ height: 12 }} />
              <Text style={{ color: '#a1a1aa', fontSize: 14 }}>Focus regions:</Text>
              <View style={{ flexDirection: 'row', flexWrap: 'wrap', gap: 8, marginTop: 8 }}>
                {['Shoulder', 'Hem', 'Waist', 'Sleeve'].map(t => (
                  <View key={t} style={{ backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: 9999, paddingHorizontal: 12, paddingVertical: 6 }}>
                    <Text style={{ color: '#d4d4d8', fontSize: 12 }}>{t}</Text>
                  </View>
                ))}
              </View>
            </Glass>
          )}
          
          {showSuggest && (
            <Glass style={{ position: 'absolute', right: 12, top: 12, width: 330, padding: 18 }}>
              <Text style={{ color: '#e4e4e7', fontWeight: '700', marginBottom: 8, fontSize: 16 }}>Suggestions</Text>
              <View style={{ flexDirection: 'row', flexWrap: 'wrap', gap: 10 }}>
                {['White sneakers', 'Crossbody bag', 'Denim overshirt', 'Pearl studs', 'Gold watch', 'Leather belt'].map(t => (
                  <View key={t} style={{ backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: 12, paddingHorizontal: 12, paddingVertical: 8 }}>
                    <Text style={{ color: '#d4d4d8', fontSize: 13 }}>{t}</Text>
                  </View>
                ))}
              </View>
            </Glass>
          )}
          
          <View style={s.bottomLeft}>
            <Pressable
              onPress={() => setRoute('product')}
              style={[s.btn, s.btnGhost]}
            >
              <Text>Change Dress</Text>
            </Pressable>
            <Pressable
              onPress={() => setRoute('askhelp')}
              style={[s.btn, s.btnPrimary]}
            >
              <Text style={s.btnPrimaryText}>Ask for Help</Text>
            </Pressable>
          </View>
          
          <View style={{ position: 'absolute', left: 12, top: 12 }}>
            <Pressable onPress={pick} style={[s.btn, s.btnGhost, { paddingHorizontal: 8, paddingVertical: 6 }]}>
              <Text style={{ color: '#fff', fontSize: 12 }}>üì∑ Change Photo</Text>
            </Pressable>
          </View>
        </View>
      </View>
    </TouchableWithoutFeedback>
  );
}

function TryOnUpload({ onUpload }) {
  const { setRoute } = useApp();
  
  const pick = async () => {
    try {
      const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permission required', 'Allow photo access.');
        return;
      }
      
      const res = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.9
      });
      
      if (!res.canceled) {
        track('upload_start');
        const publicUrl = await uploadImageAsync(res.assets[0].uri);
        onUpload(publicUrl);
        track('upload_success', { url: publicUrl });
        Alert.alert('Success', 'Photo uploaded successfully!');
      }
    } catch (error) {
      console.error('Upload error:', error);
      track('upload_error', { error: error.message });
      Alert.alert('Upload failed', 'Please try again.');
    }
  };
  
  return (
    <View style={{ gap: 16, padding: 16 }}>
      <Card>
        <Text style={s.h1}>Upload Your Photo</Text>
        <Text style={s.muted}>Upload a clear photo of yourself to try on clothes.</Text>
        <View style={{ height: 16 }} />
        <Pressable style={s.inputBox} onPress={pick}>
          <Text style={s.label}>Upload Photo <Text style={{ color: '#f87171' }}>(required)</Text></Text>
          <Text style={s.inputHint}>Tap to choose from gallery</Text>
        </Pressable>
      </Card>
      
      <Card>
        <Text style={s.h2}>How it works:</Text>
        <Text style={s.muted}>1. Upload your photo</Text>
        <Text style={s.muted}>2. Choose a product from Shop</Text>
        <Text style={s.muted}>3. See AI try-on results</Text>
        <Text style={s.muted}>4. Get styling suggestions</Text>
      </Card>
      
      <View style={{ flexDirection: 'row', gap: 8 }}>
        <Pressable onPress={() => setRoute('shop')} style={[s.btn, s.btnGhost]}><Text>Browse Shop</Text></Pressable>
        <Pressable onPress={pick} style={[s.btn, s.btnPrimary]}><Text style={s.btnPrimaryText}>Upload Photo</Text></Pressable>
      </View>
    </View>
  );
}

function AskHelp() {
  const { setRoute } = useApp();
  const [mode, setMode] = useState(null);
  const [duration, setDuration] = useState(60);
  
  const choose = (m) => {
    setMode(m);
    if (m === 'twins') setDuration(5);
  };
  
  const next = () => setRoute('createpod', { mode: mode || 'friends', title: 'Rooftop party fit', duration });
  
  const Option = ({ id, title, desc }) => (
    <Pressable
      onPress={() => choose(id)}
      style={[s.card, { padding: 16, borderRadius: 20 }, mode === id && { borderColor: '#fff' }]}
    >
      <Text style={{ fontWeight: '700', color: '#e4e4e7' }}>{title}</Text>
      <Text style={s.muted}>{desc}</Text>
    </Pressable>
  );
  
  return (
    <View style={{ gap: 14 }}>
      <Text style={s.h1}>Who should weigh in?</Text>
      <Option id="friends" title="üë• Friends Only" desc="Trusted circle. Private & collaborative." />
      <Option id="twins" title="üß¨ Taste Twins" desc="Anonymous quick signal (~5 min). No chat." />
      <Option id="broader" title="ÔøΩÔøΩ Broader Perspectives" desc="Cross-culture / general audience." />
      <Option id="mix" title="‚ú® Mix Mode" desc="Friends + AI-picked twins." />
      
      {(mode === 'friends' || mode === 'broader' || mode === 'mix') && (
        <View style={[s.card, { padding: 16, borderRadius: 20 }]}>
          <Text style={s.label}>Duration: <Text style={{ color: '#e4e4e7', fontWeight: '700' }}>{duration} mins</Text></Text>
          <View style={{ height: 10 }} />
          <View style={{ height: 4, backgroundColor: 'rgba(255,255,255,0.12)', borderRadius: 9999 }}>
            <View style={{ width: `${Math.min(duration, 120) / 1.2}%`, height: 4, backgroundColor: '#fff', borderRadius: 9999 }} />
          </View>
          <View style={{ flexDirection: 'row', gap: 8, marginTop: 10 }}>
            {[15, 30, 60, 120].map(v => (
              <Pressable key={v} onPress={() => setDuration(v)} style={[s.btn, s.btnGhost]}><Text>{v}m</Text></Pressable>
            ))}
          </View>
        </View>
      )}
      
      <View style={{ flexDirection: 'row', gap: 8 }}>
        <Pressable onPress={() => setRoute('tryon')} style={[s.btn, s.btnGhost]}><Text>Back</Text></Pressable>
        <Pressable onPress={next} style={[s.btn, s.btnPrimary]} disabled={!mode}><Text style={s.btnPrimaryText}>Create Pod ‚Üí</Text></Pressable>
      </View>
    </View>
  );
}

function CreatePod() {
  const { state: { looks, params }, setRoute, createRoom } = useApp();
  
  const confirm = () => {
    const room = createRoom({
      lookId: looks[0].id,
      mode: params.mode,
      durationMins: params.duration,
      title: params.title
    });
    setRoute('room_owner', { roomId: room.id });
  };
  
  return (
    <View style={{ gap: 16 }}>
      <Text style={s.h1}>Create Pod</Text>
      <Card>
        <Row label="Context" value={
          params.mode === 'friends' ? 'Friends Only' :
          params.mode === 'twins' ? 'Taste Twins' :
          params.mode === 'broader' ? 'Broader Perspectives' : 'Mix Mode'
        } />
        <Row label="Title" value={params.title} />
        <Row label="Duration" value={`${params.duration} minutes`} />
        {params.mode === 'twins' && <Text style={s.muted}>Twins pods are short & anonymous for quick signal.</Text>}
      </Card>
      <View style={{ flexDirection: 'row', gap: 8 }}>
        <Pressable onPress={() => setRoute('askhelp')} style={[s.btn, s.btnGhost]}><Text>Back</Text></Pressable>
        <Pressable onPress={confirm} style={[s.btn, s.btnPrimary]}><Text style={s.btnPrimaryText}>Create Pod ‚Üí</Text></Pressable>
      </View>
    </View>
  );
}

function RoomsInbox() {
  const { state: { rooms }, setRoute, tick } = useApp();
  const [, setT] = useState(0);
  
  useEffect(() => {
    const t = setInterval(() => { tick(); setT(v => v + 1); }, 1000);
    return () => clearInterval(t);
  }, []);
  
  return (
    <View style={{ gap: 12 }}>
      <Text style={s.h1}>Rooms</Text>
      {rooms.length === 0 && <Text style={s.muted}>No rooms yet. Create one from Try-On ‚Üí Ask for Help.</Text>}
      {rooms.map(r => {
        const total = r.votes.yes + r.votes.maybe + r.votes.no;
        const conf = total ? Math.round(((r.votes.yes + 0.5 * r.votes.maybe) / total) * 100) : 0;
        const remaining = Math.max(0, Math.floor((r.expiresAt - Date.now()) / 1000));
        return (
          <Card key={r.id}>
            <Text style={{ fontWeight: '700', color: '#e4e4e7' }}>{r.title} ‚Äî {r.mode.toUpperCase()}</Text>
            <Text style={s.muted}>{r.status === 'active' ? `${remaining}s left` : 'Expired'} ¬∑ Votes: üî• {r.votes.yes} ¬∑ üíØ {r.votes.maybe} ¬∑ ‚ùå {r.votes.no} ¬∑ Conf {conf}%</Text>
            <View style={{ flexDirection: 'row', gap: 8, marginTop: 8 }}>
              <Pressable onPress={() => setRoute('room_owner', { roomId: r.id })} style={[s.btn, s.btnPrimary]}><Text style={s.btnPrimaryText}>Open</Text></Pressable>
              <Pressable onPress={() => setRoute('room_guest', { roomId: r.id })} style={[s.btn, s.btnGhost]}><Text>Open as Guest</Text></Pressable>
            </View>
          </Card>
        );
      })}
    </View>
  );
}

function RoomOwner() {
  const { state: { params, rooms, looks }, setRoute, vote, tick } = useApp();
  const roomId = params?.roomId;
  const room = rooms.find(r => r.id === roomId);
  const look = looks.find(l => l.id === room?.lookId);
  const [, setT] = useState(0);
  
  useEffect(() => {
    const t = setInterval(() => { tick(); setT(v => v + 1); }, 1000);
    return () => clearInterval(t);
  }, []);
  
  if (!room || !look) return <Text>Room not found.</Text>;
  
  const total = room.votes.yes + room.votes.maybe + room.votes.no;
  const conf = total ? Math.round(((room.votes.yes + 0.5 * room.votes.maybe) / total) * 100) : 0;
  const remaining = Math.max(0, Math.floor((room.expiresAt - Date.now()) / 1000));
  
  return (
    <View style={{ gap: 12, paddingBottom: 100 }}>
      <FullImage uri={look.uri}>
        <Confidence value={conf} />
        <VoteBar onYes={() => vote(room.id, 'yes')} onMaybe={() => vote(room.id, 'maybe')} onNo={() => vote(room.id, 'no')} />
      </FullImage>
      <Text>{room.title} ‚Ä¢ {room.mode.toUpperCase()} ‚Ä¢ {room.status === 'active' ? `${remaining}s left` : 'Expired'}</Text>
      <Text style={s.muted}>Votes: üî• {room.votes.yes} ¬∑ üíØ {room.votes.maybe} ¬∑ ‚ùå {room.votes.no}</Text>
      <View style={{ flexDirection: 'row', gap: 8, flexWrap: 'wrap' }}>
        <Pressable onPress={() => Alert.alert('Share', 'Stub: universal link to invite voters.')} style={[s.btn, s.btnGhost]}><Text>Invite</Text></Pressable>
        <Pressable onPress={() => setRoute('recap', { roomId: room.id })} style={[s.btn, s.btnPrimary]}><Text style={s.btnPrimaryText}>See AI Recap</Text></Pressable>
        <Pressable onPress={() => setRoute('rooms')} style={[s.btn, s.btnGhost]}><Text>Rooms</Text></Pressable>
      </View>
    </View>
  );
}

function RoomGuest() {
  const { state: { params, rooms, looks }, vote } = useApp();
  const roomId = params?.roomId;
  const room = rooms.find(r => r.id === roomId);
  const look = looks.find(l => l.id === room?.lookId);
  
  if (!room || !look) return <Text>Room not found.</Text>;
  
  const disabled = room.status !== 'active';
  
  return (
    <View style={{ gap: 12 }}>
      <FullImage uri={look.uri}>
        <VoteBar
          onYes={() => !disabled && vote(room.id, 'yes')}
          onMaybe={() => !disabled && vote(room.id, 'maybe')}
          onNo={() => !disabled && vote(room.id, 'no')}
        />
      </FullImage>
      <Text style={s.muted}>{disabled ? 'This pod has expired.' : 'Thanks for your vote!'}</Text>
    </View>
  );
}

function Recap() {
  const { state: { params, rooms }, setRoute } = useApp();
  const room = rooms.find(r => r.id === params?.roomId);
  
  if (!room) return <Text>Not found.</Text>;
  
  const total = room.votes.yes + room.votes.maybe + room.votes.no;
  const conf = total ? Math.round(((room.votes.yes + 0.5 * room.votes.maybe) / total) * 100) : 0;
  
  return (
    <View style={{ gap: 12, paddingBottom: 100 }}>
      <Text style={s.h1}>AI Recap</Text>
      <Card>
        <Row label="Confidence" value={`${conf}%`} />
        <Row label="Votes" value={`üî• ${room.votes.yes} ¬∑ üíØ ${room.votes.maybe} ¬∑ ‚ùå ${room.votes.no}`} />
        <Row label="Takeaway" value={conf >= 70 ? 'Go for it. Add white sneakers.' : 'Consider an alternate: darker jacket or boots.'} />
      </Card>
      <View style={{ flexDirection: 'row', gap: 8 }}>
        <Pressable style={[s.btn, s.btnPrimary]}><Text style={s.btnPrimaryText}>Buy with Confidence</Text></Pressable>
        <Pressable onPress={() => setRoute('rooms')} style={[s.btn, s.btnGhost]}><Text>Back to Rooms</Text></Pressable>
      </View>
    </View>
  );
}

function Feed() {
  const { state: { feedItems, currentFeedIndex }, nextFeedItem } = useApp();
  const { user } = useUser();
  const [hasVoted, setHasVoted] = useState(false);
  const [yes, setYes] = useState(feedItems[currentFeedIndex]?.yes || 82);
  const [maybe, setMaybe] = useState(feedItems[currentFeedIndex]?.maybe || 15);
  const [no, setNo] = useState(feedItems[currentFeedIndex]?.no || 9);
  
  const currentItem = feedItems[currentFeedIndex];
  
  useEffect(() => {
    // Reset vote state when feed item changes
    setHasVoted(false);
    setYes(currentItem?.yes || 82);
    setMaybe(currentItem?.maybe || 15);
    setNo(currentItem?.no || 9);
  }, [currentFeedIndex, currentItem]);
  
  const total = yes + maybe + no;
  const score = useMemo(() => Math.round(((yes + 0.5 * maybe) / Math.max(total, 1)) * 100), [yes, maybe, no, total]);
  
  const handleVote = (type) => {
    if (hasVoted) return;
    setHasVoted(true);
    if (type === 'yes') setYes(v => v + 1);
    else if (type === 'maybe') setMaybe(v => v + 1);
    else if (type === 'no') setNo(v => v + 1);
    
    // Auto-advance to next item after 1.5 seconds
    setTimeout(() => {
      nextFeedItem();
    }, 1500);
  };
  
  if (!currentItem) return <Text>No feed items available.</Text>;
  
  return (
    <View style={{ alignItems: 'center' }}>
      <FullImage uri={currentItem.uri}>
        <UserBadge handle={currentItem.handle} sub={currentItem.sub} />
        <Confidence value={score} />
        <VoteBar
          onYes={() => handleVote('yes')}
          onMaybe={() => handleVote('maybe')}
          onNo={() => handleVote('no')}
          disabled={hasVoted}
        />
      </FullImage>
      {hasVoted && (
        <Card style={{ marginTop: 16, width: '100%', maxWidth: 420 }}>
          <Text style={s.muted}>Thanks for voting! Moving to next look...</Text>
        </Card>
      )}
      <View style={{ flexDirection: 'row', gap: 8, marginTop: 16 }}>
        <Pressable onPress={nextFeedItem} style={[s.btn, s.btnGhost]}>
          <Text>Next Look</Text>
        </Pressable>
      </View>
    </View>
  );
}

/* ---------------- Helper Components ---------------- */
function FullImage({ uri, children }) {
  return (
    <View style={s.full}>
      <Image source={{ uri }} resizeMode="cover" style={StyleSheet.absoluteFillObject} />
      {children}
    </View>
  );
}

function Confidence({ value }) {
  return (
    <View style={s.confBadge}>
      <Text style={s.mutedSmall}>Confidence {value}%</Text>
    </View>
  );
}

function VoteBar({ onYes, onMaybe, onNo, disabled }) {
  return (
    <View style={s.voteBar}>
      <Pressable
        onPress={onYes}
        style={[s.emoji, disabled && { opacity: 0.5 }]}
        disabled={disabled}
      >
        <Text style={{ fontSize: 22, color: '#fff' }}>üî•</Text>
      </Pressable>
      <Pressable
        onPress={onMaybe}
        style={[s.emoji, disabled && { opacity: 0.5 }]}
        disabled={disabled}
      >
        <Text style={{ fontSize: 22, color: '#fff' }}>üíØ</Text>
      </Pressable>
      <Pressable
        onPress={onNo}
        style={[s.emoji, disabled && { opacity: 0.5 }]}
        disabled={disabled}
      >
        <Text style={{ fontSize: 22, color: '#fff' }}>‚ùå</Text>
      </Pressable>
    </View>
  );
}

function Tag({ text }) {
  return (
    <View style={s.tag}>
      <Text style={s.tagText}>{text}</Text>
    </View>
  );
}

function RailIcon({ icon, onPress }) {
  return (
    <Pressable onPress={onPress} style={s.railBtn}>
      <Text style={{ fontSize: 18, color: '#fff' }}>{icon}</Text>
    </Pressable>
  );
}

function UserBadge({ handle, sub }) {
  return (
    <View style={s.userBadge}>
      <Text style={s.bold}>{handle}</Text>
      <Text style={s.mutedSmall}>{sub}</Text>
    </View>
  );
}

function Row({ label, value }) {
  return (
    <View style={{ flexDirection: 'row', justifyContent: 'space-between', paddingVertical: 6 }}>
      <Text style={s.muted}>{label}</Text>
      <Text style={{ color: '#e4e4e7' }}>{value}</Text>
    </View>
  );
}

function Card({ children, style }) {
  return <View style={[s.card, style]}>{children}</View>;
}

function Glass({ children, style }) {
  return (
    <View style={[{
      backgroundColor: 'rgba(0,0,0,0.45)',
      borderColor: 'rgba(255,255,255,0.14)',
      borderWidth: 1,
      borderRadius: 16,
      padding: 12
    }, style]}>
      {children}
    </View>
  );
}

function StatBar({ label, value }) {
  return (
    <View style={{ marginBottom: 8 }}>
      <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>
        <Text style={{ color: '#d4d4d8', fontSize: 12 }}>{label}</Text>
        <Text style={{ color: '#e4e4e7', fontSize: 12, fontWeight: '700' }}>{value}%</Text>
      </View>
      <View style={{ height: 6, backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: 9999, marginTop: 6 }}>
        <View style={{ width: `${value}%`, height: 6, borderRadius: 9999, backgroundColor: '#fff' }} />
      </View>
    </View>
  );
}

/* ---------------- Styles ---------------- */
const s = StyleSheet.create({
  app: { flex: 1, backgroundColor: '#000' },
  container: { flex: 1, paddingHorizontal: 16, paddingTop: 12, paddingBottom: 24, maxWidth: 720, alignSelf: 'center', width: '100%' },

  grid2: { gap: 16 },
  card: { backgroundColor: 'rgba(255,255,255,0.05)', borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, borderRadius: 24, padding: 18 },
  h1: { fontSize: 18, fontWeight: '700', color: '#e4e4e7' },
  h2: { fontSize: 16, fontWeight: '600', color: '#e4e4e7' },
  bold: { fontWeight: '700', color: '#e4e4e7' },
  muted: { color: '#a1a1aa', marginTop: 4 },
  mutedSmall: { color: '#d4d4d8', fontSize: 12 },
  inputBox: { backgroundColor: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 12, borderWidth: 1, borderColor: 'rgba(255,255,255,0.08)' },
  label: { color: '#d4d4d8', fontSize: 12 },
  inputHint: { color: '#a1a1aa', fontSize: 12, marginTop: 2 },
  inputText: { backgroundColor: 'rgba(255,255,255,0.06)', color: '#e4e4e7', paddingHorizontal: 12, paddingVertical: 10, borderRadius: 14, marginTop: 6 },

  full: { width: '100%', aspectRatio: 9 / 16, borderRadius: 24, overflow: 'hidden', position: 'relative', maxWidth: 420, alignSelf: 'center' },
  fullSmall: { width: '100%', aspectRatio: 3 / 4, borderRadius: 20, overflow: 'hidden' },
  gradDown: { ...StyleSheet.absoluteFillObject, backgroundColor: 'rgba(0,0,0,0.15)' },
  topPill: { position: 'absolute', left: 12, top: 12, backgroundColor: 'rgba(0,0,0,0.55)', paddingHorizontal: 8, paddingVertical: 4, borderRadius: 9999 },
  topPillText: { color: '#fff', fontSize: 12 },

  btn: { borderRadius: 14, paddingHorizontal: 14, paddingVertical: 10, alignItems: 'center', justifyContent: 'center' },
  btnPrimary: { backgroundColor: '#ffffff' },
  btnPrimaryText: { color: '#000000', fontWeight: '700' },
  btnGhost: { backgroundColor: 'rgba(255,255,255,0.10)' },
  btnFloating: { position: 'absolute', right: 12, bottom: 12 },

  productCard: { backgroundColor: 'rgba(255,255,255,0.05)', borderRadius: 20, overflow: 'hidden', flex: 1 },
  productTitle: { fontSize: 13, fontWeight: '600', color: '#e4e4e7' },
  productMeta: { color: '#a1a1aa', fontSize: 12, marginTop: 2 },

  row: { flexDirection: 'row', gap: 8, marginTop: 12 },
  rowBetween: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 },

  rail: { position: 'absolute', right: 8, top: 8, gap: 8 },
  railBtn: { backgroundColor: 'rgba(0,0,0,0.55)', paddingHorizontal: 14, paddingVertical: 12, borderRadius: 14, minWidth: 44, minHeight: 44, alignItems: 'center', justifyContent: 'center' },

  bottomLeft: { position: 'absolute', left: 8, bottom: 8, flexDirection: 'row', gap: 8 },

  userBadge: { position: 'absolute', left: 12, top: 12 },
  confBadge: { position: 'absolute', left: 12, bottom: 90, backgroundColor: 'rgba(0,0,0,0.55)', paddingHorizontal: 10, paddingVertical: 6, borderRadius: 9999 },
  voteBar: { position: 'absolute', left: 0, right: 0, bottom: 12, flexDirection: 'row', justifyContent: 'center', gap: 12 },
  emoji: { backgroundColor: 'rgba(0,0,0,0.55)', paddingHorizontal: 18, paddingVertical: 10, borderRadius: 9999 },

  tag: { backgroundColor: 'rgba(255,255,255,0.08)', paddingHorizontal: 10, paddingVertical: 4, borderRadius: 12 },
  tagText: { color: '#d4d4d8', fontSize: 12 },

  link: { color: '#3b82f6', marginTop: 8 },
  help: { color: '#a1a1aa', fontSize: 12, marginTop: 8, textAlign: 'center' },
});
